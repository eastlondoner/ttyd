# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ttyd is a simple command-line tool for sharing terminals over the web. It's built with C for the backend server and TypeScript/Preact for the frontend web interface.

**Key Technologies:**
- Backend: C99, libuv (async I/O), libwebsockets (WebSocket server), json-c, OpenSSL
- Frontend: TypeScript, Preact, xterm.js (terminal emulator), Webpack
- Build: CMake (backend), Yarn + Webpack + Gulp (frontend)

## Build Commands

### Backend (C)

```bash
# Initial setup (install dependencies on macOS)
brew install cmake json-c libwebsockets libuv

# Configure and build
mkdir -p build && cd build
cmake ..
make

# Install system-wide (optional)
sudo make install

# Clean build
make clean
# Or remove entire build directory
rm -rf build
```

**Build from project root:** The build process requires libwebsockets to be compiled with libuv support. If CMake fails with "libwebsockets was not build with libuv support", reinstall libwebsockets via Homebrew.

### Frontend (TypeScript/JavaScript)

```bash
cd html/

# Install dependencies
yarn install

# Development server with hot reload
yarn start

# Production build (creates optimized bundle)
yarn build

# Production build with inlined assets (generates html.h for C backend)
yarn inline

# Lint check
yarn check

# Lint fix
yarn fix
```

**Note:** The `yarn inline` command generates `src/html.h` which embeds the compiled frontend assets directly into the C binary. This is the standard build process for releases.

## Architecture

### Backend Architecture

The backend is a single-threaded C application using libuv's event loop:

1. **Entry point:** `src/server.c` - Main server setup, command-line parsing, signal handling
2. **HTTP server:** `src/http.c` - Serves the web UI and handles HTTP requests
3. **WebSocket protocol:** `src/protocol.c` - Handles WebSocket messages between browser and PTY
4. **PTY management:** `src/pty.c` - Creates and manages pseudo-terminals, process spawning
5. **Utilities:** `src/utils.c` - Helper functions (base64, signals, etc.)

**Key data structures:**
- `struct server` (server.h:64) - Global server configuration and state
- `struct pss_tty` (server.h:39) - Per-session state for WebSocket connections to PTY
- `pty_process` (pty.h) - PTY process state

**Message protocol** (server.h:7-17):
- Client → Server: `'0'` = input, `'1'` = resize, `'2'` = pause, `'3'` = resume, `'{'` = JSON
- Server → Client: `'0'` = output, `'1'` = window title, `'2'` = preferences

### Frontend Architecture

The frontend is a Preact-based single-page application:

- **Entry:** `html/src/index.tsx` - App initialization
- **Components:** `html/src/components/` - Preact components (Terminal, etc.)
- **Build:** `html/webpack.config.js` - Webpack configuration
- **Post-processing:** `html/gulpfile.js` - Gulp tasks (minify, gzip, inline)

**Build pipeline:** TypeScript → Webpack (bundle) → Gulp (minify, gzip) → inline into C header

The frontend uses xterm.js for terminal emulation with addons for WebGL rendering, clipboard, image support, and file transfer (ZMODEM/trzsz).

## Development Workflow

### Making Backend Changes

1. Edit C files in `src/`
2. Rebuild: `cd build && make`
3. Test: `./ttyd [options] <command>`
4. For debugging: `./ttyd -d 9 bash` (max debug level)

### Making Frontend Changes

1. Edit TypeScript/styles in `html/src/`
2. Run dev server: `cd html && yarn start`
3. Access at `http://localhost:8080`
4. For production build: `yarn inline` (regenerates `src/html.h`)
5. Rebuild backend to include new frontend: `cd build && make`

### Testing

**Manual testing examples:**
```bash
# Basic test with command
./build/ttyd -p 7682 -o echo "Hello from ttyd"

# Interactive shell (writable)
./build/ttyd -W -p 7682 bash

# With authentication
./build/ttyd -c username:password -p 7682 bash

# Auto-open browser
./build/ttyd -B bash

# One-shot mode (exit after first client disconnects)
./build/ttyd -o -p 7682 ls -la
```

**Common test scenarios:** See BUILD_AND_TEST.md for comprehensive testing instructions.

## Code Style

- **Backend:** Follow existing C99 style, uses `.clang-format` for formatting
- **Frontend:** Uses gts (Google TypeScript Style), run `yarn fix` to auto-format
- **Linting:** Run `yarn check` before committing frontend changes

## Important Notes

- The frontend is embedded into the C binary via `src/html.h` (generated by `yarn inline`)
- libwebsockets must be compiled with libuv support (-DLWS_WITH_LIBUV=ON)
- WebSocket connections require proper origin handling when `--check-origin` is enabled
- PTY processes are managed through libuv's child process API
- Version is derived from git tags and commits (see CMakeLists.txt:9-17)
